<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¢–∞–ª–∞–Ω—Ç–æ–≤</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: #1a1a2e; 
            color: white; 
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* –†–µ–∂–∏–º—ã */
        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .mode-btn {
            padding: 10px 20px;
            background: #4361ee;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        .mode-btn.active {
            background: #f72585;
        }
        
        /* –†–µ–∂–∏–º –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ */
        .calculator-mode {
            display: block;
        }
        .editor-mode {
            display: none;
        }
        
        /* –ö–ª–∞—Å—Å—ã */
        .class-selector {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .class-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .class-btn {
            padding: 12px 20px;
            background: #4361ee;
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
        }
        .class-btn.active {
            background: #f72585;
        }
        
        /* –í–µ—Ç–∫–∏ */
        .branches-container {
            display: grid;
            grid-template-columns: 400px 200px 200px 200px;
            gap: 20px;
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        /* –¢–∞–ª–∞–Ω—Ç—ã */
        .talent-branch {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
        }
        .talent-branch h3 {
            text-align: center;
            margin-bottom: 15px;
            color: #4cc9f0;
            border-bottom: 1px solid #4a5568;
            padding-bottom: 8px;
        }
        .talent-row {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            min-height: 80px;
        }
        .talent {
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #2d3748, #4a5568);
            border: 2px solid #718096;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            text-align: center;
            position: relative;
            padding: 5px;
        }
        .talent.active {
            background: linear-gradient(45deg, #7209b7, #3a0ca3);
            border-color: #f72585;
        }
        .talent.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .talent-level {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
        }
        
        /* –í–µ—Ö–∏ */
        .milestone-branch {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .milestone-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            gap: 4px;
            width: 180px;
            height: 180px;
        }
        .milestone {
            width: 18px;
            height: 18px;
            background: #4a5568;
            border: 2px solid #718096;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
        }
        .milestone.active {
            background: #f72585;
            border-color: #f72585;
        }
        .milestone.locked {
            opacity: 0.2;
            cursor: not-allowed;
            background: #2d3748;
        }
        .milestone.start {
            background: #4cc9f0;
            border-color: #4cc9f0;
        }
        .milestone.disabled {
            opacity: 0.1;
            cursor: not-allowed;
            background: transparent;
            border: 2px dotted #718096;
        }
        
        /* –ü–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ */
        .info-panel {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
        }
        .points-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .points-box {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .points-value {
            font-size: 24px;
            font-weight: bold;
            color: #f72585;
        }
        
        /* –†–µ–¥–∞–∫—Ç–æ—Ä */
        .editor-container {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .json-editor {
            width: 100%;
            height: 400px;
            background: #2d3748;
            color: white;
            border: 1px solid #4a5568;
            border-radius: 5px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
        }
        .editor-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .editor-btn {
            padding: 10px 20px;
            background: #4361ee;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* –¢—É–ª—Ç–∏–ø—ã */
        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            white-space: pre-line;
            z-index: 1000;
            max-width: 300px;
            border: 1px solid #4cc9f0;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¢–∞–ª–∞–Ω—Ç–æ–≤</h1>
        
        <div class="mode-selector">
            <button class="mode-btn active" onclick="switchMode('calculator')">üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</button>
            <button class="mode-btn" onclick="switchMode('editor')">‚öôÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä</button>
        </div>
        
        <!-- –†–µ–∂–∏–º –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ -->
        <div class="calculator-mode" id="calculatorMode">
            <div class="class-selector">
                <h3>–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å:</h3>
                <div class="class-buttons" id="classButtons"></div>
            </div>
            
            <div class="branches-container" id="branchesContainer"></div>
            
            <div class="info-panel">
                <div class="points-display">
                    <div class="points-box">
                        <h4>–û—á–∫–∏ —Ç–∞–ª–∞–Ω—Ç–æ–≤</h4>
                        <div class="points-value" id="talentPoints">0</div>
                        <div>–∏–∑ <span id="maxTalentPoints">30</span> –¥–æ—Å—Ç—É–ø–Ω–æ</div>
                    </div>
                    <div class="points-box">
                        <h4>–û—á–∫–∏ –≤–µ—Ö</h4>
                        <div class="points-value" id="milestonePoints">0</div>
                        <div>–∏–∑ <span id="maxMilestonePoints">41</span> –¥–æ—Å—Ç—É–ø–Ω–æ</div>
                    </div>
                </div>
                
                <div class="controls">
                    <button onclick="resetAll()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
                    <button onclick="exportBuild()">üì§ –≠–∫—Å–ø–æ—Ä—Ç –±–∏–ª–¥–∞</button>
                    <button onclick="importBuild()">üì• –ò–º–ø–æ—Ä—Ç –±–∏–ª–¥–∞</button>
                </div>
                
                <textarea id="buildCode" placeholder="–ö–æ–¥ –±–∏–ª–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å..." readonly style="width:100%; height:60px; margin-top:15px; background:#2d3748; color:white; border:none; padding:10px;"></textarea>
            </div>
        </div>
        
        <!-- –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ -->
        <div class="editor-mode" id="editorMode">
            <div class="editor-container">
                <h3>–†–µ–¥–∞–∫—Ç–æ—Ä –¥–∞–Ω–Ω—ã—Ö:</h3>
                <textarea class="json-editor" id="jsonEditor"></textarea>
                <div class="editor-controls">
                    <button class="editor-btn" onclick="loadData()">üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                    <button class="editor-btn" onclick="saveData()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                    <button class="editor-btn" onclick="resetData()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –∫ –∏—Å—Ö–æ–¥–Ω—ã–º</button>
                </div>
            </div>
            
            <div class="info-panel">
                <h3>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é:</h3>
                <p><strong>–¢–∞–ª–∞–Ω—Ç—ã:</strong> –ú–µ–Ω—è–π—Ç–µ name, desc, max, req (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è), icon</p>
                <p><strong>–í–µ—Ö–∏:</strong> –ú–µ–Ω—è–π—Ç–µ name, desc, disabledCells (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —è—á–µ–µ–∫)</p>
                <p><strong>–ù–∞—Å—Ç—Ä–æ–π–∫–∏:</strong> –ú–µ–Ω—è–π—Ç–µ maxTalentPoints –∏ maxMilestonePoints</p>
                <p><strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong> [0,0] - –ª–µ–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª, [4,4] - —Ü–µ–Ω—Ç—Ä</p>
            </div>
        </div>
    </div>

    <script>
        // –ë–ê–ó–û–í–´–ï –î–ê–ù–ù–´–ï (–º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å)
        let gameData = {
            settings: {
                maxTalentPoints: 30,
                maxMilestonePoints: 41
            },
            classes: {
                warrior: {
                    name: "‚öîÔ∏è –í–æ–∏–Ω",
                    talents: [
                        [
                            {
                                id: "war_tal_1",
                                name: "–°–∏–ª–∞ –æ—Ä—É–∂–∏—è",
                                desc: ["+2% –∫ —Å–∏–ª–µ –∞—Ç–∞–∫–∏", "+4% –∫ —Å–∏–ª–µ –∞—Ç–∞–∫–∏", "+6% –∫ —Å–∏–ª–µ –∞—Ç–∞–∫–∏"],
                                max: 3,
                                req: [],
                                icon: "‚öîÔ∏è"
                            },
                            {
                                id: "war_tal_2",
                                name: "–¢–≤–µ—Ä–¥–∞—è —Å—Ç–æ–π–∫–∞", 
                                desc: ["+3% –∫ –∑–∞—â–∏—Ç–µ", "+6% –∫ –∑–∞—â–∏—Ç–µ", "+9% –∫ –∑–∞—â–∏—Ç–µ"],
                                max: 3,
                                req: [],
                                icon: "üõ°Ô∏è"
                            }
                        ],
                        [
                            {
                                id: "war_tal_3",
                                name: "–ú–æ—â–Ω—ã–π —É–¥–∞—Ä",
                                desc: ["+5% –∫ —É—Ä–æ–Ω—É –∫—Ä–∏—Ç–∞", "+10% –∫ —É—Ä–æ–Ω—É –∫—Ä–∏—Ç–∞", "+15% –∫ —É—Ä–æ–Ω—É –∫—Ä–∏—Ç–∞"],
                                max: 3,
                                req: ["war_tal_1"],
                                icon: "üí•"
                            }
                        ]
                    ],
                    milestones: [
                        {
                            name: "‚ö° –í–µ—Ö–∞ –°–∏–ª—ã",
                            desc: "–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –±–æ–µ–≤—É—é —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å",
                            disabledCells: [[0,0], [0,8], [8,0], [8,8]]
                        },
                        {
                            name: "üõ°Ô∏è –í–µ—Ö–∞ –ó–∞—â–∏—Ç—ã", 
                            desc: "–ü–æ–≤—ã—à–∞–µ—Ç –≤—ã–∂–∏–≤–∞–µ–º–æ—Å—Ç—å",
                            disabledCells: [[1,1], [1,7], [7,1], [7,7]]
                        },
                        {
                            name: "üéØ –í–µ—Ö–∞ –¢–∞–∫—Ç–∏–∫–∏",
                            desc: "–£–ª—É—á—à–∞–µ—Ç —Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏", 
                            disabledCells: [[0,4], [4,0], [4,8], [8,4]]
                        }
                    ]
                },
                mage: {
                    name: "üîÆ –ú–∞–≥",
                    talents: [
                        [
                            {
                                id: "mag_tal_1",
                                name: "–ú–∞–≥–∏—á–µ—Å–∫–∞—è –º–æ—â—å",
                                desc: ["+3% –∫ —Å–∏–ª–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π", "+6% –∫ —Å–∏–ª–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π", "+9% –∫ —Å–∏–ª–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π"],
                                max: 3,
                                req: [],
                                icon: "üîÆ"
                            }
                        ]
                    ],
                    milestones: [
                        {
                            name: "üî• –í–µ—Ö–∞ –û–≥–Ω—è",
                            desc: "–£—Å–∏–ª–∏–≤–∞–µ—Ç –æ–≥–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è",
                            disabledCells: [[2,2], [2,6], [6,2], [6,6]]
                        },
                        {
                            name: "‚ùÑÔ∏è –í–µ—Ö–∞ –õ—å–¥–∞",
                            desc: "–£–ª—É—á—à–∞–µ—Ç –ª–µ–¥—è–Ω—ã–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è",
                            disabledCells: [[3,3], [3,5], [5,3], [5,5]]
                        }
                    ]
                }
            }
        };

        // –ü–ï–†–ï–ú–ï–ù–ù–´–ï
        let currentClass = null;
        let talentPoints = 0;
        let milestonePoints = 0;
        const selectedTalents = {};
        const selectedMilestones = {};
        let currentTooltip = null;

        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        function init() {
            loadData();
            createClassButtons();
            updateMaxPoints();
        }

        // –†–ï–ñ–ò–ú–´
        function switchMode(mode) {
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('calculatorMode').style.display = 'none';
            document.getElementById('editorMode').style.display = 'none';
            
            if (mode === 'calculator') {
                document.querySelector('.mode-btn:nth-child(1)').classList.add('active');
                document.getElementById('calculatorMode').style.display = 'block';
                renderBranches();
            } else {
                document.querySelector('.mode-btn:nth-child(2)').classList.add('active');
                document.getElementById('editorMode').style.display = 'block';
                updateEditor();
            }
        }

        // –†–ï–î–ê–ö–¢–û–†
        function updateEditor() {
            document.getElementById('jsonEditor').value = JSON.stringify(gameData, null, 2);
        }

        function loadData() {
            try {
                const newData = JSON.parse(document.getElementById('jsonEditor').value);
                gameData = newData;
                updateMaxPoints();
                createClassButtons();
                if (currentClass) renderBranches();
                alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!');
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON!');
            }
        }

        function saveData() {
            updateEditor();
            alert('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (–≤ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏)');
        }

        function resetData() {
            gameData = {
                settings: { maxTalentPoints: 30, maxMilestonePoints: 41 },
                classes: {
                    warrior: {
                        name: "‚öîÔ∏è –í–æ–∏–Ω",
                        talents: [[
                            { id: "war_tal_1", name: "–°–∏–ª–∞ –æ—Ä—É–∂–∏—è", desc: ["–†–∞–Ω–≥ 1", "–†–∞–Ω–≥ 2", "–†–∞–Ω–≥ 3"], max: 3, req: [], icon: "‚öîÔ∏è" }
                        ]],
                        milestones: [
                            { name: "–í–µ—Ö–∞ 1", desc: "–û–ø–∏—Å–∞–Ω–∏–µ –≤–µ—Ö–∏", disabledCells: [] }
                        ]
                    }
                }
            };
            updateEditor();
        }

        function updateMaxPoints() {
            document.getElementById('maxTalentPoints').textContent = gameData.settings.maxTalentPoints;
            document.getElementById('maxMilestonePoints').textContent = gameData.settings.maxMilestonePoints;
        }

        // –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê
        function createClassButtons() {
            const container = document.getElementById('classButtons');
            container.innerHTML = '';
            
            for (const classId in gameData.classes) {
                const btn = document.createElement('button');
                btn.className = 'class-btn';
                btn.textContent = gameData.classes[classId].name;
                btn.onclick = () => selectClass(classId);
                container.appendChild(btn);
            }
        }

        function selectClass(classId) {
            currentClass = classId;
            talentPoints = 0;
            milestonePoints = 0;
            
            // –û—á–∏—â–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–∞–ª–∞–Ω—Ç—ã –∏ –≤–µ—Ö–∏
            Object.keys(selectedTalents).forEach(key => delete selectedTalents[key]);
            Object.keys(selectedMilestones).forEach(key => delete selectedMilestones[key]);
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –≤–µ—Ö–∏
            gameData.classes[classId].milestones.forEach((milestone, index) => {
                selectedMilestones[`${classId}_milestone_${index}_4_4`] = true;
                milestonePoints++;
            });
            
            document.querySelectorAll('.class-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            renderBranches();
            updatePoints();
        }

        function renderBranches() {
            const container = document.getElementById('branchesContainer');
            container.innerHTML = '';
            
            const classData = gameData.classes[currentClass];
            
            // –í–µ—Ç–∫–∞ —Ç–∞–ª–∞–Ω—Ç–æ–≤
            const talentBranch = document.createElement('div');
            talentBranch.className = 'talent-branch';
            talentBranch.innerHTML = '<h3>üéØ –¢–∞–ª–∞–Ω—Ç—ã</h3>';
            
            classData.talents.forEach((row, rowIndex) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'talent-row';
                
                row.forEach(talent => {
                    const talentDiv = document.createElement('div');
                    talentDiv.className = 'talent';
                    const currentLevel = selectedTalents[talent.id] || 0;
                    const isLocked = talent.req.length > 0 && !talent.req.every(req => selectedTalents[req] > 0);
                    
                    if (currentLevel > 0) talentDiv.classList.add('active');
                    if (isLocked) talentDiv.classList.add('locked');
                    
                    talentDiv.innerHTML = `
                        <div style="font-size: 16px; margin-bottom: 5px;">${talent.icon || '‚ùì'}</div>
                        <div style="font-size: 9px; line-height: 1.1;">${talent.name}</div>
                        <div class="talent-level">${currentLevel}/${talent.max}</div>
                    `;
                    
                    // –¢—É–ª—Ç–∏–ø
                    const desc = talent.desc[Math.min(currentLevel, talent.desc.length - 1)];
                    talentDiv.setAttribute('data-tooltip', `${talent.name}\n\n${desc}\n\n–£—Ä–æ–≤–µ–Ω—å: ${currentLevel}/${talent.max}`);
                    
                    talentDiv.addEventListener('mouseenter', showTooltip);
                    talentDiv.addEventListener('mouseleave', hideTooltip);
                    talentDiv.addEventListener('click', () => toggleTalent(talent.id, talent.max, talent.req));
                    
                    rowDiv.appendChild(talentDiv);
                });
                
                talentBranch.appendChild(rowDiv);
            });
            
            container.appendChild(talentBranch);
            
            // –í–µ—Ç–∫–∏ –≤–µ—Ö
            classData.milestones.forEach((milestone, milestoneIndex) => {
                const milestoneBranch = document.createElement('div');
                milestoneBranch.className = 'milestone-branch';
                milestoneBranch.innerHTML = `<h3>${milestone.name}</h3>`;
                
                milestoneBranch.setAttribute('data-tooltip', `${milestone.name}\n\n${milestone.desc}`);
                milestoneBranch.addEventListener('mouseenter', showTooltip);
                milestoneBranch.addEventListener('mouseleave', hideTooltip);
                
                const grid = document.createElement('div');
                grid.className = 'milestone-grid';
                
                // –°–æ–∑–¥–∞–µ–º —Å–µ—Ç–∫—É 9x9
                for (let i = 0; i < 9; i++) {
                    for (let j = 0; j < 9; j++) {
                        const cellDiv = document.createElement('div');
                        cellDiv.className = 'milestone';
                        const cellId = `${currentClass}_milestone_${milestoneIndex}_${i}_${j}`;
                        const isStart = (i === 4 && j === 4);
                        const isDisabled = milestone.disabledCells.some(([x, y]) => x === i && y === j);
                        
                        if (isDisabled) {
                            cellDiv.classList.add('disabled');
                        } else if (isStart) {
                            cellDiv.classList.add('start');
                            cellDiv.classList.add('active');
                        } else if (selectedMilestones[cellId]) {
                            cellDiv.classList.add('active');
                        }
                        
                        const isLocked = !isStart && !isDisabled && !isMilestoneAvailable(currentClass, milestoneIndex, i, j);
                        if (isLocked) cellDiv.classList.add('locked');
                        
                        cellDiv.setAttribute('data-tooltip', `–ü–æ–∑–∏—Ü–∏—è: ${i+1},${j+1}\n\n${isStart ? '–°—Ç–∞—Ä—Ç–æ–≤–∞—è —Ç–æ—á–∫–∞' : '–í–µ—Ö–∞'}`);
                        cellDiv.addEventListener('mouseenter', showTooltip);
                        cellDiv.addEventListener('mouseleave', hideTooltip);
                        
                        if (!isDisabled && !isLocked) {
                            cellDiv.addEventListener('click', () => toggleMilestone(cellId, i, j));
                        }
                        
                        grid.appendChild(cellDiv);
                    }
                }
                
                milestoneBranch.appendChild(grid);
                container.appendChild(milestoneBranch);
            });
        }

        function isMilestoneAvailable(classId, milestoneIndex, row, col) {
            if (row === 4 && col === 4) return true; // –°—Ç–∞—Ä—Ç–æ–≤–∞—è –∫–ª–µ—Ç–∫–∞
            
            const neighbors = [
                [row-1, col], [row+1, col], [row, col-1], [row, col+1]
            ];
            
            return neighbors.some(([r, c]) => {
                return r >= 0 && r < 9 && c >= 0 && c < 9 && 
                       selectedMilestones[`${classId}_milestone_${milestoneIndex}_${r}_${c}`];
            });
        }

        function toggleTalent(talentId, maxLevel, requirements) {
            if (talentPoints >= gameData.settings.maxTalentPoints) return;
            
            const currentLevel = selectedTalents[talentId] || 0;
            const isLocked = requirements.length > 0 && !requirements.every(req => selectedTalents[req] > 0);
            
            if (isLocked) {
                alert('–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è —ç—Ç–æ–≥–æ —Ç–∞–ª–∞–Ω—Ç–∞!');
                return;
            }
            
            if (currentLevel < maxLevel) {
                selectedTalents[talentId] = currentLevel + 1;
                talentPoints++;
            } else {
                delete selectedTalents[talentId];
                talentPoints--;
            }
            
            updatePoints();
            renderBranches();
        }

        function toggleMilestone(milestoneId, row, col) {
            if (milestonePoints >= gameData.settings.maxMilestonePoints && !selectedMilestones[milestoneId]) return;
            
            if (selectedMilestones[milestoneId]) {
                delete selectedMilestones[milestoneId];
                milestonePoints--;
            } else {
                selectedMilestones[milestoneId] = true;
                milestonePoints++;
            }
            
            updatePoints();
            renderBranches();
        }

        function updatePoints() {
            document.getElementById('talentPoints').textContent = talentPoints;
            document.getElementById('milestonePoints').textContent = milestonePoints;
        }

        function resetAll() {
            talentPoints = 0;
            milestonePoints = 0;
            Object.keys(selectedTalents).forEach(key => delete selectedTalents[key]);
            Object.keys(selectedMilestones).forEach(key => delete selectedMilestones[key]);
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –≤–µ—Ö–∏ –∑–∞–Ω–æ–≤–æ
            if (currentClass) {
                gameData.classes[currentClass].milestones.forEach((milestone, index) => {
                    selectedMilestones[`${currentClass}_milestone_${index}_4_4`] = true;
                    milestonePoints++;
                });
            }
            
            updatePoints();
            renderBranches();
        }

        function exportBuild() {
            const build = {
                class: currentClass,
                talents: selectedTalents,
                milestones: selectedMilestones,
                talentPoints: talentPoints,
                milestonePoints: milestonePoints
            };
            document.getElementById('buildCode').value = btoa(JSON.stringify(build));
        }

        function importBuild() {
            const code = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –±–∏–ª–¥–∞:');
            if (code) {
                try {
                    const build = JSON.parse(atob(code));
                    currentClass = build.class;
                    Object.assign(selectedTalents, build.talents);
                    Object.assign(selectedMilestones, build.milestones);
                    talentPoints = build.talentPoints || 0;
                    milestonePoints = build.milestonePoints || 0;
                    
                    document.querySelectorAll('.class-btn').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.textContent === gameData.classes[currentClass].name) {
                            btn.classList.add('active');
                        }
                    });
                    
                    updatePoints();
                    renderBranches();
                    alert('–ë–∏–ª–¥ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!');
                } catch (e) {
                    alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞!');
                }
            }
        }

        // –¢–£–õ–¢–ò–ü–´
        function showTooltip(event) {
            hideTooltip();
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.textContent = event.target.getAttribute('data-tooltip');
            document.body.appendChild(tooltip);
            
            const rect = event.target.getBoundingClientRect();
            tooltip.style.left = (rect.left + window.scrollX) + 'px';
            tooltip.style.top = (rect.top + window.scrollY - tooltip.offsetHeight - 10) + 'px';
            
            currentTooltip = tooltip;
        }

        function hideTooltip() {
            if (currentTooltip) {
                currentTooltip.remove();
                currentTooltip = null;
            }
        }

        // –ó–ê–ü–£–°–ö
        window.addEventListener('load', init);
    </script>
</body>
</html>
